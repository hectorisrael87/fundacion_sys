{% extends "base.html" %}
{% block title %}Agregar producto{% endblock %}

{% block content %}
<style>
  /* ComboBox dropdown */
  .combo-list{
    margin-top:6px;
    border:1px solid var(--line);
    background:#fff;
    border-radius:14px;
    max-height:260px;
    overflow:auto;
    box-shadow: var(--shadow);
  }
  .combo-item{
    padding:10px 12px;
    cursor:pointer;
    display:flex;
    justify-content:space-between;
    gap:10px;
  }
  .combo-item:hover{
    background:#f1f5f9;
  }
  .combo-muted{
    color: var(--muted);
    font-size:12px;
  }
  /* Modal: que el contenido scrollee y las acciones no se desborden */
  .modal-panel{
    max-height: 92vh;
    overflow: hidden;
  }

  .modal-panel .card{
    display: flex;
    flex-direction: column;
    max-height: 92vh;
  }

  /* el form/cuerpo puede scrollear */
  .modal-panel .card form{
    flex: 1;
    min-height: 0;
    overflow: auto;
    padding-bottom: 12px;
  }

  /* acciones siempre visibles */
  .modal-actions{
    position: sticky;
    bottom: 0;
    background: #fff;
    padding-top: 10px;
    padding-bottom: 10px;
    border-top: 1px solid var(--line);
    z-index: 5;
  }

</style>

<div class="modal">
  <a class="modal-backdrop" href="{% url 'cc_detail' cc.pk %}" aria-label="Cerrar"></a>
  <div class="modal-panel">
    <div class="card">
      <div class="modal-header">
        <div>
          <h2 class="m0">{{ cc.number }} ‚Äì Agregar producto</h2>
          <div class="muted mt-xs">Agrega un producto al cuadro.</div>
        </div>
      </div>

      <div class="mt-md" style="display:flex; gap:8px; flex-wrap:wrap;">
        <a class="btn btn-ghost btn-sm" href="{% url 'product_create' %}?next={% url 'cc_add_item' cc.pk %}">
          ‚ûï Crear producto nuevo
        </a>

        <a class="btn btn-ghost btn-sm" href="#" onclick="return openEditProduct();">
          ‚úèÔ∏è Editar seleccionado
        </a>

        <a class="btn btn-ghost btn-sm" href="#" onclick="return openDeleteProduct();">
          üóëÔ∏è Eliminar seleccionado
        </a>
      </div>

      <form method="post" class="mt-md">
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="error">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="form-grid">

          <div class="field">
            <div class="label">Producto</div>

            <!-- ‚úÖ √öNICO buscador (combo box) -->
            <input
              type="text"
              id="productComboInput"
              class="control"
              placeholder="Buscar y seleccionar producto‚Ä¶"
              autocomplete="off"
            />

            <div id="productComboList" class="combo-list" style="display:none;"></div>

            <!-- ‚úÖ Mantener el select real (para POST), pero oculto -->
            <div style="display:none;">
              {{ form.producto }}
            </div>

            {% if form.producto.errors %}<div class="error">{{ form.producto.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <div class="label">Unidad</div>
            {{ form.unidad }}
            {% if form.unidad.errors %}<div class="error">{{ form.unidad.errors }}</div>{% endif %}
          </div>

          <div class="field">
            <div class="label">Cantidad</div>
            {{ form.cantidad }}
            {% if form.cantidad.errors %}<div class="error">{{ form.cantidad.errors }}</div>{% endif %}
          </div>

        </div>

        <div class="modal-actions">
          <button class="btn btn-primary" type="submit">‚ûï Agregar</button>
          <a class="btn btn-ghost" href="{% url 'cc_detail' cc.pk %}">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
(function(){
  const select = document.getElementById("id_producto"); // select real
  const input  = document.getElementById("productComboInput");
  const list   = document.getElementById("productComboList");
  if(!select || !input || !list) return;

  const options = Array.from(select.options)
    .filter(o => o.value) // sin placeholder
    .map(o => ({ value:o.value, text:(o.textContent || "").trim() }));

  function closeList(){ list.style.display = "none"; list.innerHTML = ""; }
  function openList(){ list.style.display = "block"; }

  function render(items){
    list.innerHTML = "";
    if(items.length === 0){
      list.innerHTML = `<div class="combo-item"><span class="combo-muted">Sin resultados‚Ä¶</span></div>`;
      openList();
      return;
    }
    for(const it of items){
      const div = document.createElement("div");
      div.className = "combo-item";
      div.innerHTML = `<span>${it.text}</span><span class="combo-muted">#${it.value}</span>`;
      div.addEventListener("click", () => {
        select.value = it.value;
        input.value = it.text;
        closeList();
        const qty = document.getElementById("id_cantidad");
        if(qty) qty.focus();
      });
      list.appendChild(div);
    }
    openList();
  }

  input.addEventListener("focus", () => render(options.slice(0, 30)));

  input.addEventListener("input", () => {
    const q = input.value.trim().toLowerCase();
    const filtered = q
      ? options.filter(o => o.text.toLowerCase().includes(q)).slice(0, 50)
      : options.slice(0, 30);
    render(filtered);
  });

  document.addEventListener("click", (e) => {
    if(e.target === input || list.contains(e.target)) return;
    closeList();
  });

  // ‚úÖ Autoselecci√≥n al volver de crear producto (?created_product=ID)
  const params = new URLSearchParams(window.location.search);
  const created = params.get("created_product");
  if(created){
    const found = options.find(o => o.value === created);
    if(found){
      select.value = found.value;
      input.value = found.text;
      const qty = document.getElementById("id_cantidad");
      if(qty) qty.focus();
    }
  }

  // ‚úÖ Editar / Eliminar (desactivar) seleccionado
  window.openEditProduct = function () {
    const id = select.value;
    if (!id) { alert("Selecciona un producto primero."); return false; }
    const next = encodeURIComponent(window.location.pathname + window.location.search);
    window.location.href = `/productos/${id}/editar/?next=${next}`;
    return false;
  }

  window.openDeleteProduct = function () {
    const id = select.value;
    if (!id) { alert("Selecciona un producto primero."); return false; }
    const ok = confirm("¬øDesactivar este producto? (Recomendado, no se borra hist√≥rico)");
    if (!ok) return false;
    const next = encodeURIComponent(window.location.pathname + window.location.search);
    window.location.href = `/productos/${id}/eliminar/?next=${next}`;
    return false;
  }
})();
</script>
{% endblock %}
