{% extends "base.html" %}
{% load dict_extras %}
{% block title %}{{ cc.number }}{% endblock %}

{% block content %}

<div class="stack">

  <!-- 1) CABECERA -->
  <div class="card">
  <div class="hstack between items-start">
    <div>
      <h2 class="m0">Cuadro comparativo: {{ cc.number }}</h2>

      <div class="detail-meta mt-sm">
          <span class="pill
            {% if cc.estado == 'BORRADOR' %}draft
            {% elif cc.estado == 'EN_REVISION' %}pending
            {% elif cc.estado == 'REVISADO' %}reviewed
            {% elif cc.estado == 'APROBADO' %}approved
            {% elif cc.estado == 'RECHAZADO' %}rejected
            {% endif %}
          ">
            {{ cc.get_estado_display }}
          </span>
          <span>Fecha: <b>{{ cc.creado_en|date:"d/m/Y H:i" }}</b></span>

          {% if can_edit_cc %}
            {% if user.is_superuser or is_reviewer or cc.creado_por_id == user.id %}
              <a class="btn btn-ghost btn-sm" href="{% url 'cc_edit_header' cc.pk %}">‚úèÔ∏è Editar cabecera</a>
            {% endif %}
          {% endif %}
      </div>


      {% if cc_bloqueado %}
        <div class="muted mt-sm">üîí Edici√≥n bloqueada.</div>
      {% endif %}


      <div class="mt-md">
        <div><b>Item cotizado:</b> {{ cc.item_cotizado }}</div>
        <div><b>Proyecto:</b> {{ cc.proyecto }}</div>
        <div><b>Expresado en:</b> {{ cc.expresado_en }}</div>
      </div>

      <div class="mt-md hstack">
        <b>√ìrdenes creadas:</b>

        {% if ordenes %}
          <span class="hstack mt-xs">
            {% for op in ordenes %}
              <a class="btn btn-sm btn-softcyan" href="{% url 'op_detail' op.id %}?return_cc={{ cc.pk }}">
                {{ op.number }}
              </a>
            {% endfor %}
          </span>
        {% else %}
          <span class="muted">Ninguna</span>
        {% endif %}
      </div>
    </div>

    <div class="hstack">
      <a class="btn btn-ghost" href="{% url 'cc_list' %}">‚Üê Volver</a>
    </div>
  </div>
</div>


  <!-- 2) PRODUCTOS -->
  <div class="card">
    <div class="hstack between">
      <h3 class="m0">Productos</h3>

      {% if can_edit_cc %}
        <a class="btn" href="{% url 'cc_add_item' cc.pk %}">‚ûï Agregar / Editar productos</a>
      {% else %}
        <span class="muted">üîí Agregar/editar bloqueado</span>
      {% endif %}
    </div>

    <table class="table table-fixed" style="margin-top:12px;">
      <thead>
        <tr>
          <th class="w-55">Producto</th>
          <th class="w-20">Unidad</th>
          <th class="w-15 text-right">Cantidad</th>
          <th class="w-10 text-right">Acci√≥n</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
          <tr>
            <td>{{ it.producto.nombre }}</td>
            <td>{{ it.unidad }}</td>
            <td class="text-right">{{ it.cantidad|floatformat:2 }}</td>
            <td class="text-right">
              {% if can_edit_cc %}
                <a href="{% url 'cc_edit_item' cc.pk it.id %}">‚úèÔ∏è</a>
                &nbsp;
                <a href="{% url 'cc_delete_item' cc.pk it.id %}">üóëÔ∏è</a>
              {% else %}
                <span class="muted">‚Äî</span>
              {% endif %}
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="4">Sin productos.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 3) PROVEEDORES -->
  <div class="card">
    <div class="hstack between">
      <h3 class="m0">Proveedores</h3>

      {% if can_edit_cc %}
        <a class="btn" href="{% url 'cc_add_supplier' cc.pk %}">‚ûï Agregar / Editar proveedores</a>
      {% else %}
        <span class="muted">üîí Agregar/editar bloqueado</span>
      {% endif %}
    </div>

    <table class="table table-fixed" style="margin-top:12px;">
      <thead>
        <tr>
          <tr>
            <th class="w-55">Proveedor</th>
            <th class="w-35">Detalle / Motivo</th>
            <th class="w-10 text-right nowrap">Acciones</th>
          </tr>
        </tr>
      </thead>
      <tbody>
        {% for ps in proveedores %}
          <tr>
            <td>{{ ps.proveedor.nombre_empresa }}</td>
            <td>{{ ps.detalle|default:"-" }}</td>
            <td class="text-right nowrap">
              
              {% if can_edit_cc %}
                
                <a title="Editar proveedor (en el cuadro)" href="{% url 'cc_edit_supplier' cc.pk ps.id %}">‚úèÔ∏è</a>
                &nbsp;
                <a title="Quitar del cuadro" href="{% url 'cc_delete_supplier' cc.pk ps.id %}">üóëÔ∏è</a>
              {% endif %}
              &nbsp;|&nbsp;
              <a title="Editar proveedor" href="{% url 'provider_edit' ps.proveedor.id %}?next={{ request.path }}">üè¢</a>
            </td>
          </tr>
        {% empty %}
          <tr><td colspan="3">Sin proveedores.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- 4) PRECIOS Y TOTALES -->
  <div class="card">
    <div class="hstack between">
      <h3 class="m0">Precios y Totales</h3>

      {% if can_edit_cc %}
        <a class="btn" href="{% url 'cc_prices' cc.pk %}">üí≤ Cargar / Editar matriz</a>
      {% else %}
        <a class="btn btn-ghost" href="{% url 'cc_prices' cc.pk %}">üëÅÔ∏è Ver matriz</a>
      {% endif %}
    </div>
    <div class="table-scroll mt-md">
      <table class="table minw-900">
        <thead>
          <tr>
            <th>Producto</th>
            <th class="text-right">Cantidad</th>
            {% for ps in proveedores %}
              <th class="text-right">{{ ps.proveedor.nombre_empresa }}</th>
            {% endfor %}
          </tr>
        </thead>

        <tbody>
          {% for it in items %}
            <tr>
              <td>{{ it.producto.nombre }}</td>
              <td class="text-right">{{ it.cantidad|floatformat:2 }} {{ it.unidad }}</td>

              {% for ps in proveedores %}
                {% with prov_prices=precios|get_item:ps.proveedor_id %}
                  {% with pu=prov_prices|get_item:it.producto_id %}
                    <td class="text-right">
                      {% if pu %}
                        <div class="muted" style="font-size:12px;">PU: {{ pu|floatformat:2 }}</div>
                        <div style="font-weight:600; font-size:12px;">
                          ({{ it.cantidad|floatformat:2 }} √ó {{ pu|floatformat:2 }})
                        </div>
                      {% else %}
                        ‚Äî
                      {% endif %}
                    </td>
                  {% endwith %}
                {% endwith %}
              {% endfor %}
            </tr>
          {% empty %}
            <tr><td colspan="{{ proveedores|length|add:'2' }}">Sin datos.</td></tr>
          {% endfor %}

          <tr>
            <td colspan="2" class="text-right" style="border-top:2px solid var(--line);"><b>Total por proveedor</b></td>
            {% for ps in proveedores %}
              <td class="text-right" style="border-top:2px solid var(--line);">
                {% with key=ps.proveedor_id|stringformat:"s" %}
                  <b>{{ totales_por_proveedor|get_item:key|floatformat:2 }}</b>
                {% endwith %}
              </td>
            {% endfor %}
          </tr>

          <tr>
            <td colspan="{{ proveedores|length|add:'2' }}" class="text-right"><b>Total general: {{ total_general|floatformat:2 }}</b></td>
          </tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- 5) PROVEEDOR SELECCIONADO - MOTIVO -->
  <div class="card">
    <div class="hstack between">
      <h3 class="m0">Proveedor seleccionado - Motivo</h3>

      {% if can_edit_cc %}
        <a class="btn" href="{% url 'cc_select_supplier' cc.pk %}">‚úÖ Seleccionar proveedor</a>
      {% else %}
        <span class="muted">üîí Selecci√≥n bloqueada</span>
      {% endif %}
    </div>

    <div class="mt-md">
      {% if cc.proveedor_seleccionado %}
        <p class="kv"><b>Proveedor:</b> {{ cc.proveedor_seleccionado.proveedor.nombre_empresa }}</p>
        <p class="kv"><b>Motivo:</b> {{ cc.motivo_seleccion|default:"-" }}</p>
      {% else %}
        <p>No se ha seleccionado proveedor.</p>
      {% endif %}
    </div>
  </div>

  <!-- 6) REGISTRO -->
  <div class="card kv">
    <h3 class="m0">Registro</h3>

    <p>
      <b>Creado por:</b> {{ cc.creado_por.get_full_name|default:cc.creado_por.username }}
      {% if cc.creado_en %} ({{ cc.creado_en|date:"d/m/Y H:i" }}){% endif %}
    </p>

    <p>
      <b>Revisado por:</b>
      {% if cc.revisado_por %}
        {{ cc.revisado_por.get_full_name|default:cc.revisado_por.username }}
        {% if cc.revisado_en %} ({{ cc.revisado_en|date:"d/m/Y H:i" }}){% endif %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>

    <p>
      <b>Aprobado por:</b>
      {% if cc.aprobado_por %}
        {{ cc.aprobado_por.get_full_name|default:cc.aprobado_por.username }}
        {% if cc.aprobado_en %} ({{ cc.aprobado_en|date:"d/m/Y H:i" }}){% endif %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
      {% if cc.rechazado_por and cc.rechazado_en %}
        <p><b>Rechazado por:</b> {{ cc.rechazado_por.get_full_name|default:cc.rechazado_por.username }}</p>
        <p><b>Rechazado en:</b> {{ cc.rechazado_en|date:"d/m/Y H:i" }}</p>
      {% endif %}

  </div>
    <!-- DOCUMENTOS Y COTIZACIONES -->
  <div class="card">
    <div class="hstack between items-start">
      <div>
        <h3 class="m0">Documentos y cotizaciones</h3>
        <div class="muted mt-sm">Adjunta las cotizaciones (PDF/imagen) para respaldar el cuadro.</div>
      </div>

      {% if can_edit_docs %}
        <form method="post"
              action="{% url 'cc_attachment_upload' cc.pk %}"
              enctype="multipart/form-data"
              class="hstack file-actions">
          {% csrf_token %}
          {{ attachment_form.archivo }}
          <button class="btn btn-sm" type="submit">üìé Adjuntar</button>
        </form>
      {% else %}
        <span class="muted">‚Äî</span>
      {% endif %}
    </div>

    <div class="mt-md">
      <table class="table">
        <thead>
          <tr>
            <th>Archivo</th>
            <th>Subido por</th>
            <th class="nowrap">Fecha</th>
            <th class="text-right nowrap">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {% for a in adjuntos %}
            <tr>
              <td>
                <a class="link-plain" href="{{ a.archivo.url }}" target="_blank" rel="noopener">
                  {{ a.nombre|default:"Documento" }}
                </a>
              </td>
              <td>{{ a.subido_por.get_full_name|default:a.subido_por.username }}</td>
              <td class="nowrap">{{ a.subido_en|date:"d/m/Y H:i" }}</td>
              <td class="text-right nowrap">
                <a class="btn btn-ghost btn-sm no-underline" href="{{ a.archivo.url }}" target="_blank" rel="noopener">üëÅÔ∏è</a>
                {% if can_edit_docs %}
                  <form method="post"
                        action="{% url 'cc_attachment_delete' cc.pk a.id %}"
                        class="inline-form">
                    {% csrf_token %}
                    <button class="btn btn-danger btn-sm" type="submit">üóëÔ∏è</button>
                  </form>
                {% else %}
                  <span class="muted">‚Äî</span>
                {% endif %}
              </td>
            </tr>
          {% empty %}
            <tr><td colspan="4">Sin documentos adjuntos.</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 7) SELECCI√ìN Y FLUJO -->
  <div class="card">
    <h3 class="m0">Selecci√≥n y flujo</h3>

    <div class="hstack mt-md">
       {% if cc.estado == "BORRADOR" %}
        {% if user.is_superuser or cc.creado_por_id == user.id %}

          {% if not cc_ready_for_review %}
            <div class="mt-sm muted">
              <b>Antes de enviar a revisi√≥n, completa:</b>
              <ul class="mt-xs">
                {% if not cc_has_items %}<li>Productos</li>{% endif %}
                {% if not cc_has_proveedores %}<li>Proveedores</li>{% endif %}
                {% if not cc_matriz_completa %}<li>Precios y Totales (matriz completa)</li>{% endif %}
                {% if not cc_has_selected_supplier %}<li>Proveedor seleccionado</li>{% endif %}
                {% if not cc_has_motivo %}<li>Motivo</li>{% endif %}
                {% if not cc_has_ops %}<li>√ìrdenes de pago generadas</li>{% endif %}
                {% if cc_has_ops and not cc_has_ops_complete %}<li>Completar √ìrdenes de Pago (descripci√≥n obligatoria)</li>{% endif %}

              </ul>
            </div>

            <span class="btn btn-primary btn-sm" style="opacity:.5; pointer-events:none;">
              üì§ Enviar a revisi√≥n
            </span>
          {% else %}
            <a class="btn btn-primary" href="{% url 'cc_send_review' cc.pk %}">üì§ Enviar a revisi√≥n</a>
          {% endif %}

        {% else %}
          <span class="muted">üìù En borrador (solo el creador puede enviar a revisi√≥n).</span>
        {% endif %}

      {% elif cc.estado == "EN_REVISION" %}
        {% if is_reviewer %}

          {# Entrada al c√≠rculo de revisi√≥n de OPs #}
          {% if first_pending_op_id %}
            <a class="btn btn-ghost" href="{% url 'op_detail' first_pending_op_id %}?return_cc={{ cc.pk }}">
              üõ†Ô∏è Revisar √≥rdenes de pago
            </a>
          {% endif %}
          {% if ops_total %}
            {% if ops_all_reviewed %}
              <span class="tag tag-ok">
                ‚úÖ OP revisadas: <b>{{ ops_reviewed_count }}/{{ ops_total }}</b>
              </span>
            {% else %}
              <span class="tag tag-warn">
                ‚ö†Ô∏è OP revisadas: <b>{{ ops_reviewed_count }}/{{ ops_total }}</b>
                {% if ops_pending_count > 0 %} ¬∑ Pendientes: {{ ops_pending_count }}{% endif %}
              </span>
            {% endif %}
          {% endif %}
  
          {# Bloqueo: solo permitir marcar CC como revisado cuando TODAS las OP est√©n REVISADO #}
          {% if ops_all_reviewed %}
            <a class="btn btn-primary" href="{% url 'cc_mark_reviewed' cc.pk %}">
              ‚úÖ Marcar como revisado
            </a>
          {% else %}
            <span class="btn btn-primary btn-sm" style="opacity:.5; pointer-events:none;">
              ‚úÖ Marcar como revisado
            </span>
            <span class="muted" style="margin-left:8px;">
              Primero marca como revisadas todas las OP.
            </span>
          {% endif %}

          <a class="btn btn-ghost" href="{% url 'cc_back_to_draft' cc.pk %}">‚Ü©Ô∏è Devolver a borrador</a>

        {% else %}
          <span class="muted">‚è≥ Pendiente de revisi√≥n.</span>
        {% endif %}
      {% elif cc.estado == "REVISADO" %}
        {% if is_approver and not is_reviewer %}

          {% if approver_seen_ops or user.is_superuser %}

            {% if first_op_id %}
              <a class="btn btn-ghost" href="{% url 'op_detail' first_op_id %}?return_cc={{ cc.pk }}">
                üëÅÔ∏è Ver √≥rdenes de pago
              </a>
            {% endif %}

            <form method="post" action="{% url 'cc_approve_final' cc.pk %}" class="inline-form">
              {% csrf_token %}
              <button class="btn btn-primary" type="submit"
                onclick="return confirm('¬øAprobar el Cuadro {{ cc.number }} y sus √ìrdenes de Pago?');">
                ‚úÖ Aprobar todo
              </button>
            </form>

            <form method="post" action="{% url 'cc_back_to_review' cc.pk %}" class="inline-form">
              {% csrf_token %}
              <button class="btn btn-ghost" type="submit"
                onclick="return confirm('¬øDevolver el Cuadro {{ cc.number }} y sus √ìrdenes a revisi√≥n?');">
                ‚Ü©Ô∏è Devolver a revisi√≥n
              </button>
            </form>

            <form method="post" action="{% url 'cc_reject' cc.pk %}" class="inline-form">
              {% csrf_token %}
              <button class="btn btn-danger" type="submit"
                onclick="return confirm('¬øRechazar el Cuadro {{ cc.number }} y sus √ìrdenes de Pago?');">
                ‚ùå Rechazar todo
              </button>
            </form>

          {% else %}

            {% if first_op_id %}
              <a class="btn btn-ghost" href="{% url 'op_detail' first_op_id %}?return_cc={{ cc.pk }}">
                üëÅÔ∏è Revisar √≥rdenes de pago
              </a>
            {% endif %}

            <span class="btn btn-primary btn-sm" style="opacity:.5; pointer-events:none;">
              ‚úÖ Aprobar todo
            </span>

            <span class="btn btn-ghost btn-sm" style="opacity:.5; pointer-events:none;">
              ‚Ü©Ô∏è Devolver a revisi√≥n
            </span>

            <span class="btn btn-danger btn-sm" style="opacity:.5; pointer-events:none;">
              ‚ùå Rechazar todo
            </span>

            <span class="muted" style="margin-left:8px;">
              Antes de aprobar, revisa al menos una orden (c√≠rculo de lectura).
            </span>

          {% endif %}

        {% else %}
          <span class="muted">‚è≥ Pendiente de aprobaci√≥n.</span>
        {% endif %}
          
      {% endif %} {# ‚úÖ cierre del if cc.estado (BORRADOR/EN_REVISION/REVISADO) #}
      {% if user.is_superuser or cc.creado_por_id == user.id %}
        {% if not cc_has_ops %}
          <a class="btn" href="{% url 'cc_generate_ops' cc.pk %}">üßæ Generar √≥rdenes de pago</a>
        {% elif not cc_has_ops_complete and cc_first_incomplete_op_id %}
          <a class="btn" href="{% url 'op_detail' cc_first_incomplete_op_id %}?return_cc={{ cc.pk }}">
            üõ†Ô∏è Completar √≥rdenes de pago
          </a>
        {% endif %}
      {% endif %}

      {% url 'cc_print' cc.pk as cc_print_url %}
      {% if cc_print_url %}
        <a class="btn btn-ghost" href="{{ cc_print_url }}" target="_blank">üñ®Ô∏è Imprimir</a>
      {% endif %}
    </div>

    <div class="mt-md">
      <b>√ìrdenes creadas:</b>

      {% if ordenes %}
        <div class="mt-sm">
          <table class="table">
            <thead>
              <tr>
                <th style="width:160px;">N√∫mero</th>
                <th>Proveedor</th>
                <th style="width:180px;">Estado</th>
                <th style="width:140px;">Acciones</th>
              </tr>
            </thead>
            <tbody>
              {% for op in ordenes %}
                {# OP completa: descripci√≥n no vac√≠a; si es parcial, monto_manual requerido #}
                {% if op.descripcion %}
                  {% if op.es_parcial %}
                    {% if op.monto_manual %}
                      <tr>
                        <td>{{ op.number }}</td>
                        <td>{{ op.proveedor.nombre_empresa|default:"-" }}</td>
                        <td>‚úÖ Completa</td>
                        <td>
                          {% if op.id in seen_op_ids %}
                            <span class="tag tag-ok">üëÅÔ∏è Vista</span>
                          {% endif %}
                          <a class="btn btn-ghost btn-sm"
                            href="{% url 'op_detail' op.id %}?return_cc={{ cc.pk }}">
                            üëÅÔ∏è Ver
                          </a>
                        </td>
                      </tr>
                    {% else %}
                      <tr>
                        <td>{{ op.number }}</td>
                        <td>{{ op.proveedor.nombre_empresa|default:"-" }}</td>
                        <td>‚ö†Ô∏è Incompleta</td>
                        <td>
                          {% if op.id in seen_op_ids %}
                            <span class="tag tag-ok">üëÅÔ∏è Vista</span>
                          {% endif %}
                          <a class="btn btn-primary btn-sm"
                            href="{% url 'op_detail' op.id %}?return_cc={{ cc.pk }}">
                            üõ†Ô∏è Completar
                          </a>
                        </td>
                      </tr>
                    {% endif %}
                  {% else %}
                    <tr>
                      <td>{{ op.number }}</td>
                      <td>{{ op.proveedor.nombre_empresa|default:"-" }}</td>
                      <td>‚úÖ Completa</td>
                      <td>
                        {% if op.id in seen_op_ids %}
                          <span class="tag tag-ok">üëÅÔ∏è Vista</span>
                        {% endif %}
                        <a class="btn btn-ghost btn-sm"
                          href="{% url 'op_detail' op.id %}?return_cc={{ cc.pk }}">
                          üëÅÔ∏è Ver
                        </a>
                      </td>
                    </tr>
                  {% endif %}
                {% else %}
                  <tr>
                    <td>{{ op.number }}</td>
                    <td>{{ op.proveedor.nombre_empresa|default:"-" }}</td>
                    <td>‚ö†Ô∏è Incompleta</td>
                    <td>
                      {% if op.id in seen_op_ids %}
                        <span class="tag tag-ok">üëÅÔ∏è Vista</span>
                      {% endif %}
                      <a class="btn btn-primary btn-sm"
                        href="{% url 'op_detail' op.id %}?return_cc={{ cc.pk }}">
                        üõ†Ô∏è Completar
                      </a>
                    </td>
                  </tr>
                {% endif %}
              {% endfor %}
            </tbody>

          </table>
        </div>
      {% else %}
        <div class="muted mt-sm">Ninguna</div>
      {% endif %}
    </div>

  </div>

</div>

{% endblock %}
