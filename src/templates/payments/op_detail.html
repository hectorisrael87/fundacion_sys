{% extends "base.html" %}
{% block content %}

<div class="card">
  <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap;">
    <div>
      <h2 style="margin:0;">Orden de pago: {{ op.number }}</h2>
      <div class="muted" style="margin-top:4px;">
        Estado: <b>{{ op.get_estado_display }}</b> |
        Cuadro: <a href="{% url 'cc_detail' op.cuadro.id %}">{{ op.cuadro.number }}</a>

        {% if op.es_parcial %}
          | <b>Pago parcial (anticipo)</b>
        {% endif %}

        {% if op.es_parcial and restante is not None %}
          | Restante: <b>{{ restante|floatformat:2 }}</b>
        {% endif %}

        {% if complemento %}
          | Complemento: <a href="{% url 'op_detail' complemento.pk %}">{{ complemento.number }}</a>
        {% endif %}
      </div>
    </div>

    <div style="display:flex; gap:10px; flex-wrap:wrap;">
      <a class="btn" href="{% url 'op_print' op.pk %}" target="_blank">üñ®Ô∏è Imprimir</a>

      {# =========================
         FLUJO: BORRADOR -> EN_REVISION -> REVISADO -> APROBADO
         ========================= #}

      {% if op.estado == "BORRADOR" %}
        {% if puede_editar %}
          <a class="btn" href="{% url 'op_send_review' op.pk %}">üì§ Enviar a revisi√≥n</a>
        {% else %}
          <span class="muted">Solo el creador puede enviar a revisi√≥n.</span>
        {% endif %}
      {% elif op.estado == "EN_REVISION" %}
        {% if is_reviewer %}
          <a class="btn" href="{% url 'op_mark_reviewed' op.pk %}">‚úÖ Marcar como revisado</a>
          <a class="btn" href="{% url 'op_back_to_draft' op.pk %}">‚Ü©Ô∏è Devolver a borrador</a>
        {% else %}
          <span class="muted">‚è≥ Pendiente de revisi√≥n.</span>
        {% endif %}
      {% elif op.estado == "REVISADO" %}
        {% if is_approver %}
          <a class="btn" href="{% url 'op_approve' op.pk %}">‚úÖ Aprobar</a>
        {% else %}
          <span class="muted">‚è≥ Pendiente de aprobaci√≥n.</span>
        {% endif %}
      {% elif op.estado == "APROBADO" %}
        <span class="muted">‚úÖ Esta OP ya est√° aprobada.</span>
      {% endif %}

      {% if puede_crear_complemento %}
        <a class="btn" href="{% url 'op_create_complement' op.pk %}">‚ûï Crear pago complementario</a>
      {% endif %}

      <a class="btn" href="{% url 'op_list' %}">‚Üê Volver</a>
    </div>
  </div>
</div>

<form method="post">
  {% csrf_token %}

  <div class="card" style="margin-top:14px;">
    <h3 style="margin-top:0;">Datos de la orden</h3>

    {% if not puede_editar %}
      <div class="muted" style="margin-bottom:10px;">
        Esta orden no est√° en <b>BORRADOR</b>. Solo se puede editar en BORRADOR (o un administrador, seg√∫n reglas del sistema).
      </div>
    {% endif %}

    <table style="width:100%; border-collapse:collapse;">
      <tr>
        <td style="padding:6px; width:15%;"><b>Para:</b></td>
        <td style="padding:6px; width:35%;">{% if puede_editar %}{{ form.para }}{% else %}{{ op.para|default:"-" }}{% endif %}</td>

        <td style="padding:6px; width:15%;"><b>Cargo Para:</b></td>
        <td style="padding:6px; width:35%;">{% if puede_editar %}{{ form.cargo_para }}{% else %}{{ op.cargo_para|default:"-" }}{% endif %}</td>
      </tr>

      <tr>
        <td style="padding:6px;"><b>De:</b></td>
        <td style="padding:6px;">{% if puede_editar %}{{ form.de }}{% else %}{{ op.de|default:"-" }}{% endif %}</td>

        <td style="padding:6px;"><b>Cargo De:</b></td>
        <td style="padding:6px;">{% if puede_editar %}{{ form.cargo_de }}{% else %}{{ op.cargo_de|default:"-" }}{% endif %}</td>
      </tr>

      <tr>
        <td style="padding:6px;"><b>Fecha solicitud:</b></td>
        <td style="padding:6px;">{% if puede_editar %}{{ form.fecha_solicitud }}{% else %}{{ op.fecha_solicitud }}{% endif %}</td>

        <td style="padding:6px;"><b>Monto Solicitado:</b></td>
        <td style="padding:6px;">{% if puede_editar %}{{ form.monto_manual }}{% else %}{{ op.monto_manual|default:"-" }}{% endif %}</td>
      </tr>

      <tr>
        <td style="padding:6px;"><b>Pago parcial:</b></td>
        <td style="padding:6px;">
          {% if puede_editar %}
            {{ form.es_parcial }}
            <span class="muted" style="margin-left:6px;">(marcar si es anticipo)</span>
          {% else %}
            {% if op.es_parcial %}S√≠{% else %}No{% endif %}
          {% endif %}
        </td>

        <td style="padding:6px;"></td>
        <td style="padding:6px;"></td>
      </tr>
    </table>

    {% if puede_editar %}
      <div style="margin-top:12px;">
        <button class="btn" type="submit">üíæ Guardar cambios</button>
      </div>
    {% endif %}
  </div>

  <div class="card" style="margin-top:14px;">
    <h3 style="margin-top:0;">Descripci√≥n</h3>
    {% if puede_editar %}
      {{ form.descripcion }}
    {% else %}
      <div style="white-space:pre-wrap;">{{ op.descripcion|default:"-" }}</div>
    {% endif %}
  </div>

  <div class="card" style="margin-top:14px;">
    <h3 style="margin-top:0;">Detalle (√çtems)</h3>

    <table class="table" style="width:100%; border-collapse:collapse;">
      <thead>
        <tr>
          <th style="width:55%; text-align:left; border-bottom:1px solid #ddd; padding:8px;">Producto</th>
          <th style="width:15%; text-align:right; border-bottom:1px solid #ddd; padding:8px;">Cantidad</th>
          <th style="width:15%; text-align:right; border-bottom:1px solid #ddd; padding:8px;">PU</th>
          <th style="width:15%; text-align:right; border-bottom:1px solid #ddd; padding:8px;">Subtotal</th>
        </tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td style="padding:8px;">{{ it.producto.nombre }}</td>
          <td style="padding:8px; text-align:right;">{{ it.cantidad|floatformat:2 }} {{ it.unidad }}</td>
          <td style="padding:8px; text-align:right;">{{ it.precio_unit|floatformat:2 }}</td>
          <td style="padding:8px; text-align:right;">{{ it.subtotal|floatformat:2 }}</td>
        </tr>
        {% empty %}
        <tr><td colspan="4" style="padding:8px;">Sin √≠tems.</td></tr>
        {% endfor %}

        <tr>
          <td colspan="3" style="padding:8px; text-align:right; font-weight:bold;">Total calculado</td>
          <td style="padding:8px; text-align:right; font-weight:bold;">{{ total|floatformat:2 }}</td>
        </tr>
      </tbody>
    </table>
  </div>

  <div class="card" style="margin-top:14px;">
    <h3 style="margin-top:0;">Informaci√≥n de Pago</h3>

    <table style="width:100%; border-collapse:collapse;">
      <tr>
        <td style="padding:6px; width:15%;"><b>Proyecto:</b></td>
        <td style="padding:6px; width:35%;">{% if puede_editar %}{{ form.proyecto }}{% else %}{{ op.proyecto|default:"-" }}{% endif %}</td>

        <td style="padding:6px; width:15%;"><b>Partida contable:</b></td>
        <td style="padding:6px; width:35%;">{% if puede_editar %}{{ form.partida_contable }}{% else %}{{ op.partida_contable|default:"-" }}{% endif %}</td>
      </tr>

      <tr>
        <td style="padding:6px;"><b>Con factura:</b></td>
        <td style="padding:6px;">{% if puede_editar %}{{ form.con_factura }}{% else %}{{ op.con_factura|default:"-" }}{% endif %}</td>

        <td style="padding:6px;"><b>Efectivo:</b></td>
        <td style="padding:6px;">{% if puede_editar %}{{ form.efectivo }}{% else %}{{ op.efectivo|default:"-" }}{% endif %}</td>
      </tr>

      <tr>
        <td style="padding:6px;"><b>Total a pagar:</b></td>
        <td style="padding:6px;"><b>{{ monto_a_pagar|floatformat:2 }}</b></td>

        <td style="padding:6px;"><b>Son:</b></td>
        <td style="padding:6px;">{{ monto_letras }}</td>
      </tr>
    </table>
  </div>

  <div class="card" style="margin-top:14px;">
    <h3 style="margin-top:0;">Proveedor</h3>
    <p><b>Nombre:</b> {{ op.proveedor.nombre_empresa }}</p>
    <p><b>Direcci√≥n:</b> {{ op.proveedor.direccion|default:"-" }}</p>
    <p><b>Tel√©fono:</b> {{ op.proveedor.telefono|default:"-" }}</p>
    <p><b>CI:</b> {{ op.proveedor.ci|default:"-" }} &nbsp; <b>NIT:</b> {{ op.proveedor.nit|default:"-" }}</p>
    <p><b>Datos de transferencia:</b> {{ op.proveedor.datos_transferencia|default:"-" }}</p>
    <p><b>Entidad:</b> {{ op.proveedor.entidad|default:"-" }}</p>
    <p><b>Nro. Cuenta:</b> {{ op.proveedor.nro_cuenta|default:"-" }}</p>
  </div>

</form>

<div class="card" style="margin-top:14px;">
  <h3 style="margin-top:0;">Registro</h3>

  <p style="margin:6px 0;">
    <b>Creado por:</b> {{ op.creado_por.get_full_name|default:op.creado_por.username }}
    {% if op.creado_en %} ({{ op.creado_en|date:"d/m/Y H:i" }}){% endif %}
  </p>

  <p style="margin:6px 0;">
    <b>Revisado por:</b>
    {% if op.revisado_por %}
      {{ op.revisado_por.get_full_name|default:op.revisado_por.username }}
      {% if op.revisado_en %} ({{ op.revisado_en|date:"d/m/Y H:i" }}){% endif %}
    {% else %}
      ‚Äî
    {% endif %}
  </p>

  <p style="margin:6px 0;">
    <b>Aprobado por:</b>
    {% if op.aprobado_por %}
      {{ op.aprobado_por.get_full_name|default:op.aprobado_por.username }}
      {% if op.aprobado_en %} ({{ op.aprobado_en|date:"d/m/Y H:i" }}){% endif %}
    {% else %}
      ‚Äî
    {% endif %}
  </p>
</div>

{% endblock %}
