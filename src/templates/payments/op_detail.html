{% extends "base.html" %}
{% block content %}

<div class="stack">

  <div class="card">
    <div class="hstack between items-start">
      <div>
        <h2 class="m0">Orden de pago: {{ op.number }}</h2>

        <div class="muted mt-xs">
          Estado:
          <span class="pill
            {% if op.estado == 'BORRADOR' %}draft
            {% elif op.estado == 'EN_REVISION' %}pending
            {% elif op.estado == 'REVISADO' %}reviewed
            {% elif op.estado == 'APROBADO' %}approved
            {% elif op.estado == 'RECHAZADO' %}rejected
            {% endif %}
          ">
            {{ op.get_estado_display }}
          </span>
          |

          Cuadro: <a href="{% url 'cc_detail' op.cuadro.id %}">{{ op.cuadro.number }}</a>

          {% if op.es_parcial %}
            | <b>Pago parcial (anticipo)</b>
          {% endif %}

          {% if op.es_parcial and restante is not None %}
            | Restante: <b>{{ restante|floatformat:2 }}</b>
          {% endif %}

          {% if complemento %}
            | Complemento: <a href="{% url 'op_detail' complemento.pk %}">{{ complemento.number }}</a>
          {% endif %}
        </div>

        {# Mensaje de estado arriba (solo texto) #}
        <div class="mt-sm">
          {% if op.estado == "BORRADOR" %}
            <span class="muted">üìù En borrador.</span>
          {% elif op.estado == "EN_REVISION" %}
            {% if is_reviewer %}
              <span class="muted">üõ†Ô∏è En revisi√≥n: puedes corregir y luego marcar como revisado.</span>
            {% else %}
              <span class="muted">‚è≥ Pendiente de revisi√≥n.</span>
            {% endif %}
          {% elif op.estado == "REVISADO" %}
            {% if is_approver %}
              <span class="muted">‚è≥ Pendiente de aprobaci√≥n.</span>
            {% else %}
              <span class="muted">‚úÖ Revisado (pendiente de aprobaci√≥n).</span>
            {% endif %}
          {% elif op.estado == "APROBADO" %}
            <span class="muted">‚úÖ Esta OP ya est√° aprobada.</span>
          {% endif %}
        </div>
      </div>

      {# SOLO Imprimir y Complemento arriba (no movemos esto) #}
      <div class="hstack">
        <a class="btn btn-ghost" href="{% url 'op_print' op.pk %}" target="_blank">üñ®Ô∏è Imprimir</a>

        {% if puede_crear_complemento %}
          <a class="btn" href="{% url 'op_create_complement' op.pk %}">‚ûï Crear pago complementario</a>
        {% endif %}
      </div>
    </div>
  </div>

  <form method="post"
        class="stack"
        action="{% url 'op_detail' op.pk %}{% if return_cc_pk %}?return_cc={{ return_cc_pk }}{% endif %}">
    {% csrf_token %}
    {% if return_cc_pk %}
      <input type="hidden" name="return_cc" value="{{ return_cc_pk }}">
    {% endif %}
    {% if next_op_pk %}
      <input type="hidden" name="next_op_pk" value="{{ next_op_pk }}">
    {% endif %}


    <div class="card">
      <h3 class="m0">Datos de la orden</h3>

      <div class="form-grid">
        <div class="field">
          <div class="label">Para</div>
          {% if puede_editar %}
            {{ form.para }}
            {{ form.para.errors }}
          {% else %}
            <div class="control control-static">{{ op.para|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Cargo Para</div>
          {% if puede_editar %}
            {{ form.cargo_para }}
            {{ form.cargo_para.errors }}
          {% else %}
            <div class="control control-static">{{ op.cargo_para|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">De</div>
          {% if puede_editar %}
            {{ form.de }}
            {{ form.de.errors }}
          {% else %}
            <div class="control control-static">{{ op.de|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Cargo De</div>
          {% if puede_editar %}
            {{ form.cargo_de }}
            {{ form.cargo_de.errors }}
          {% else %}
            <div class="control control-static">
              {% if op.cargo_de %}
                {{ op.cargo_de }}
              {% else %}
                {{ op.creado_por.userprofile.cargo|default:"-" }}
              {% endif %}
            </div>

          {% endif %}
        </div>

        <div class="field">
          <div class="label">Fecha solicitud</div>
          {% if puede_editar %}
            {{ form.fecha_solicitud }}
            {{ form.fecha_solicitud.errors }}
          {% else %}
            <div class="control control-static">{{ op.fecha_solicitud }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Monto solicitado</div>
          {% if op.es_parcial %}
            {# Pago parcial: monto manual requerido #}
            {{ form.monto_manual }}
            <div class="muted">Pago parcial: debes ingresar el monto solicitado.</div>
          {% else %}
            {# OP normal: mostrar total calculado (no vac√≠o) #}
            <div class="control" style="background:#f7f7f7;">
              {{ total_calculado|floatformat:2 }}
            </div>
            <div class="muted">OP normal: el monto solicitado es el total calculado.</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Pago parcial</div>
          {% if puede_editar %}
            <div class="hstack">
              {{ form.es_parcial }}
              <span class="muted">(marcar si es anticipo)</span>
            </div>
            {{ form.es_parcial.errors }}
          {% else %}
            <div class="control control-static">{% if op.es_parcial %}S√≠{% else %}No{% endif %}</div>
          {% endif %}
        </div>

        <div class="field"></div>
      </div>
    </div>
    <div class="field" style="grid-column: 1 / -1;">
      <div class="label">Descripci√≥n</div>
      {% if puede_editar %}
        {{ form.descripcion }}
        {{ form.descripcion.errors }}
      {% else %}
        <div class="control control-static">{{ op.descripcion|default:"-" }}</div>
      {% endif %}
    </div>
    

    <div class="card">
      <h3 class="m0">Detalle (√çtems)</h3>

      <table class="table">
        <thead>
          <tr>
            <th style="width:55%;">Producto</th>
            <th class="text-right" style="width:15%;">Cantidad</th>
            <th class="text-right" style="width:15%;">PU</th>
            <th class="text-right" style="width:15%;">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.producto.nombre }}</td>
            <td class="text-right">{{ it.cantidad|floatformat:2 }} {{ it.unidad }}</td>
            <td class="text-right">{{ it.precio_unit|floatformat:2 }}</td>
            <td class="text-right">{{ it.subtotal|floatformat:2 }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">Sin √≠tems.</td></tr>
          {% endfor %}

          <tr>
            <td colspan="3" class="text-right"><b>Total calculado</b></td>
            <td class="text-right"><b>{{ total|floatformat:2 }}</b></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3 class="m0">Informaci√≥n de Pago</h3>

      <div class="form-grid">
        <div class="field">
          <div class="label">Proyecto</div>
          {% if puede_editar %}
            {{ form.proyecto }}
            {{ form.proyecto.errors }}
          {% else %}
            <div class="control control-static">{{ op.proyecto|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Partida contable</div>
          {% if puede_editar %}
            {{ form.partida_contable }}
            {{ form.partida_contable.errors }}
          {% else %}
            <div class="control control-static">{{ op.partida_contable|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Con factura</div>
          {% if puede_editar %}
            {{ form.con_factura }}
            {{ form.con_factura.errors }}
          {% else %}
            <div class="control control-static">{{ op.con_factura|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Efectivo</div>
          {% if puede_editar %}
            {{ form.efectivo }}
            {{ form.efectivo.errors }}
          {% else %}
            <div class="control control-static">{{ op.efectivo|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Total a pagar</div>
          <div class="control control-static"><b>{{ monto_a_pagar|floatformat:2 }}</b></div>
        </div>

        <div class="field">
          <div class="label">Son</div>
          <div class="control control-static">{{ monto_letras }}</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="m0">Proveedor</h3>
      <div class="mt-sm">
        <p><b>Nombre:</b> {{ op.proveedor.nombre_empresa }}</p>
        <p><b>Direcci√≥n:</b> {{ op.proveedor.direccion|default:"-" }}</p>
        <p><b>Tel√©fono:</b> {{ op.proveedor.telefono|default:"-" }}</p>
        <p><b>CI:</b> {{ op.proveedor.ci|default:"-" }} &nbsp; <b>NIT:</b> {{ op.proveedor.nit|default:"-" }}</p>
        <p><b>Datos de transferencia:</b> {{ op.proveedor.datos_transferencia|default:"-" }}</p>
        <p><b>Entidad:</b> {{ op.proveedor.entidad|default:"-" }}</p>
        <p><b>Nro. Cuenta:</b> {{ op.proveedor.nro_cuenta|default:"-" }}</p>
      </div>
    </div>
    <div class="card kv">
      <h3 class="m0">Registro</h3>

      <p>
        <b>Creado por:</b> {{ op.creado_por.get_full_name|default:op.creado_por.username }}
        {% if op.creado_en %} ({{ op.creado_en|date:"d/m/Y H:i" }}){% endif %}
      </p>

      <p>
        <b>Revisado por:</b>
        {% if op.revisado_por %}
          {{ op.revisado_por.get_full_name|default:op.revisado_por.username }}
          {% if op.revisado_en %} ({{ op.revisado_en|date:"d/m/Y H:i" }}){% endif %}
        {% else %}
          ‚Äî
        {% endif %}
      </p>

      <p>
        <b>Aprobado por:</b>
        {% if op.aprobado_por %}
          {{ op.aprobado_por.get_full_name|default:op.aprobado_por.username }}
          {% if op.aprobado_en %} ({{ op.aprobado_en|date:"d/m/Y H:i" }}){% endif %}
        {% else %}
          ‚Äî
        {% endif %}
      </p>
      {% if op.rechazado_por and op.rechazado_en %}
        <p><b>Rechazado por:</b> {{ op.rechazado_por.get_full_name|default:op.rechazado_por.username }}</p>
        <p><b>Rechazado en:</b> {{ op.rechazado_en|date:"d/m/Y H:i" }}</p>
      {% endif %}

    </div>
    {# Botones abajo (despu√©s de Registro) - √öNICO bloque #}
    <div class="card">
      <div class="hstack">

        {% if op.estado == "BORRADOR" and puede_editar %}
          {% if op.creado_por_id == user.id or user.is_superuser %}

            <button class="btn btn-ghost" type="submit" name="action" value="save">üíæ Guardar</button>

            {% if return_cc_pk %}
              {% if next_op_pk %}
                <button class="btn btn-primary" type="submit" name="action" value="save_next">
                  üíæ Guardar y siguiente ‚Üí
                </button>
              {% else %}
                <button class="btn btn-primary" type="submit" name="action" value="save_return_cc">
                  ‚úì Guardar y volver al cuadro
                </button>
              {% endif %}
            {% else %}
              <button class="btn btn-primary" type="submit" name="action" value="send_review">
                üì§ Guardar y enviar a revisi√≥n
              </button>
            {% endif %}
          {% endif %}
        {% endif %}

        {% if op.estado == "EN_REVISION" and is_reviewer %}
          {% if puede_editar %}
            <button class="btn btn-ghost" type="submit" name="action" value="save">üíæ Guardar</button>
          {% endif %}

          <a class="btn btn-primary"
            href="{% url 'op_mark_reviewed' op.pk %}{% if return_cc_pk %}?return_cc={{ return_cc_pk }}{% endif %}">
            ‚úÖ Marcar como revisado
          </a>

          <a class="btn btn-ghost"
            href="{% url 'op_back_to_draft' op.pk %}{% if return_cc_pk %}?return_cc={{ return_cc_pk }}{% endif %}">
            ‚Ü©Ô∏è Devolver a borrador
          </a>
        {% endif %}

        {% if op.estado == "REVISADO" and is_approver and not is_reviewer %}
          {% if return_cc_pk %}
            <span class="muted">üëÅÔ∏è Lectura en grupo: aprueba / devuelve / rechaza desde el Cuadro Comparativo.</span>
          {% else %}
            <button class="btn btn-primary" type="submit" formaction="{% url 'op_approve' op.pk %}" formmethod="post">‚úÖ Aprobar</button>
            <button class="btn btn-ghost" type="submit" formaction="{% url 'op_back_to_review' op.pk %}" formmethod="post">‚Ü©Ô∏è Devolver a revisi√≥n</button>
            <button class="btn btn-danger" type="submit" formaction="{% url 'op_reject' op.pk %}" formmethod="post"
                    onclick="return confirm('¬øRechazar la OP {{ op.number }}?');">‚ùå Rechazar</button>
          {% endif %}
        {% endif %}

        {% if op.estado == "APROBADO" %}
          <span class="muted">‚úÖ OP aprobada.</span>
        {% elif op.estado == "RECHAZADO" %}
          <span class="muted">‚ùå OP rechazada.</span>
        {% endif %}

        {% if return_cc_pk %}
          <a class="btn btn-ghost" href="{% url 'cc_detail' return_cc_pk %}">‚Üê Volver al cuadro</a>
          {% if next_op_pk %}
            <a class="btn btn-primary" href="{% url 'op_detail' next_op_pk %}?return_cc={{ return_cc_pk }}">Siguiente orden ‚Üí</a>
          {% else %}
            <a class="btn btn-primary" href="{% url 'cc_detail' return_cc_pk %}">‚úì Terminar y volver al cuadro</a>
          {% endif %}
        {% else %}
          <a class="btn btn-ghost" href="{% url 'op_list' %}">‚Üê Volver</a>
        {% endif %}

      </div>
    </div>

  </form>

</div>

{% endblock %}
