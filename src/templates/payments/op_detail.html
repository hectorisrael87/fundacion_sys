{% extends "base.html" %}
{% block content %}

<div class="stack">

  <div class="card">
    <div class="hstack between items-start">
      <div>
        <h2 class="m0">Orden de pago: {{ op.number }}</h2>

        <div class="muted mt-xs">
          Estado: <b>{{ op.get_estado_display }}</b> |
          Cuadro: <a href="{% url 'cc_detail' op.cuadro.id %}">{{ op.cuadro.number }}</a>

          {% if op.es_parcial %}
            | <b>Pago parcial (anticipo)</b>
          {% endif %}

          {% if op.es_parcial and restante is not None %}
            | Restante: <b>{{ restante|floatformat:2 }}</b>
          {% endif %}

          {% if complemento %}
            | Complemento: <a href="{% url 'op_detail' complemento.pk %}">{{ complemento.number }}</a>
          {% endif %}
        </div>

        {# Mensaje de estado arriba (solo texto) #}
        <div class="mt-sm">
          {% if op.estado == "BORRADOR" %}
            <span class="muted">üìù En borrador.</span>
          {% elif op.estado == "EN_REVISION" %}
            {% if is_reviewer %}
              <span class="muted">üõ†Ô∏è En revisi√≥n: puedes corregir y luego marcar como revisado.</span>
            {% else %}
              <span class="muted">‚è≥ Pendiente de revisi√≥n.</span>
            {% endif %}
          {% elif op.estado == "REVISADO" %}
            {% if is_approver %}
              <span class="muted">‚è≥ Pendiente de aprobaci√≥n.</span>
            {% else %}
              <span class="muted">‚úÖ Revisado (pendiente de aprobaci√≥n).</span>
            {% endif %}
          {% elif op.estado == "APROBADO" %}
            <span class="muted">‚úÖ Esta OP ya est√° aprobada.</span>
          {% endif %}
        </div>
      </div>

      {# SOLO Imprimir y Complemento arriba (no movemos esto) #}
      <div class="hstack">
        <a class="btn btn-ghost" href="{% url 'op_print' op.pk %}" target="_blank">üñ®Ô∏è Imprimir</a>

        {% if puede_crear_complemento %}
          <a class="btn" href="{% url 'op_create_complement' op.pk %}">‚ûï Crear pago complementario</a>
        {% endif %}
      </div>
    </div>
  </div>

  <form method="post" class="stack">
    {% csrf_token %}

    <div class="card">
      <h3 class="m0">Datos de la orden</h3>

      <div class="form-grid">
        <div class="field">
          <div class="label">Para</div>
          {% if puede_editar %}
            {{ form.para }}
            {{ form.para.errors }}
          {% else %}
            <div class="control control-static">{{ op.para|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Cargo Para</div>
          {% if puede_editar %}
            {{ form.cargo_para }}
            {{ form.cargo_para.errors }}
          {% else %}
            <div class="control control-static">{{ op.cargo_para|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">De</div>
          {% if puede_editar %}
            {{ form.de }}
            {{ form.de.errors }}
          {% else %}
            <div class="control control-static">{{ op.de|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Cargo De</div>
          {% if puede_editar %}
            {{ form.cargo_de }}
            {{ form.cargo_de.errors }}
          {% else %}
            <div class="control control-static">
              {% if op.cargo_de %}
                {{ op.cargo_de }}
              {% else %}
                {{ op.creado_por.userprofile.cargo|default:"-" }}
              {% endif %}
            </div>

          {% endif %}
        </div>

        <div class="field">
          <div class="label">Fecha solicitud</div>
          {% if puede_editar %}
            {{ form.fecha_solicitud }}
            {{ form.fecha_solicitud.errors }}
          {% else %}
            <div class="control control-static">{{ op.fecha_solicitud }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Monto solicitado</div>
          {% if puede_editar %}
            {{ form.monto_manual }}
            {{ form.monto_manual.errors }}
          {% else %}
            <div class="control control-static">{{ op.monto_manual|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Pago parcial</div>
          {% if puede_editar %}
            <div class="hstack">
              {{ form.es_parcial }}
              <span class="muted">(marcar si es anticipo)</span>
            </div>
            {{ form.es_parcial.errors }}
          {% else %}
            <div class="control control-static">{% if op.es_parcial %}S√≠{% else %}No{% endif %}</div>
          {% endif %}
        </div>

        <div class="field"></div>
      </div>

      {% if puede_editar %}
        <div class="mt-md">
          <button class="btn btn-primary" type="submit">üíæ Guardar cambios</button>
        </div>
      {% endif %}
    </div>

    <div class="card">
      <h3 class="m0">Descripci√≥n</h3>
      <div class="mt-sm">
        {% if puede_editar %}
          {{ form.descripcion }}
          {{ form.descripcion.errors }}
        {% else %}
          <div class="prewrap">{{ op.descripcion|default:"-" }}</div>
        {% endif %}
      </div>
    </div>

    <div class="card">
      <h3 class="m0">Detalle (√çtems)</h3>

      <table class="table">
        <thead>
          <tr>
            <th style="width:55%;">Producto</th>
            <th class="text-right" style="width:15%;">Cantidad</th>
            <th class="text-right" style="width:15%;">PU</th>
            <th class="text-right" style="width:15%;">Subtotal</th>
          </tr>
        </thead>
        <tbody>
          {% for it in items %}
          <tr>
            <td>{{ it.producto.nombre }}</td>
            <td class="text-right">{{ it.cantidad|floatformat:2 }} {{ it.unidad }}</td>
            <td class="text-right">{{ it.precio_unit|floatformat:2 }}</td>
            <td class="text-right">{{ it.subtotal|floatformat:2 }}</td>
          </tr>
          {% empty %}
          <tr><td colspan="4">Sin √≠tems.</td></tr>
          {% endfor %}

          <tr>
            <td colspan="3" class="text-right"><b>Total calculado</b></td>
            <td class="text-right"><b>{{ total|floatformat:2 }}</b></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="card">
      <h3 class="m0">Informaci√≥n de Pago</h3>

      <div class="form-grid">
        <div class="field">
          <div class="label">Proyecto</div>
          {% if puede_editar %}
            {{ form.proyecto }}
            {{ form.proyecto.errors }}
          {% else %}
            <div class="control control-static">{{ op.proyecto|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Partida contable</div>
          {% if puede_editar %}
            {{ form.partida_contable }}
            {{ form.partida_contable.errors }}
          {% else %}
            <div class="control control-static">{{ op.partida_contable|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Con factura</div>
          {% if puede_editar %}
            {{ form.con_factura }}
            {{ form.con_factura.errors }}
          {% else %}
            <div class="control control-static">{{ op.con_factura|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Efectivo</div>
          {% if puede_editar %}
            {{ form.efectivo }}
            {{ form.efectivo.errors }}
          {% else %}
            <div class="control control-static">{{ op.efectivo|default:"-" }}</div>
          {% endif %}
        </div>

        <div class="field">
          <div class="label">Total a pagar</div>
          <div class="control control-static"><b>{{ monto_a_pagar|floatformat:2 }}</b></div>
        </div>

        <div class="field">
          <div class="label">Son</div>
          <div class="control control-static">{{ monto_letras }}</div>
        </div>
      </div>
    </div>

    <div class="card">
      <h3 class="m0">Proveedor</h3>
      <div class="mt-sm">
        <p><b>Nombre:</b> {{ op.proveedor.nombre_empresa }}</p>
        <p><b>Direcci√≥n:</b> {{ op.proveedor.direccion|default:"-" }}</p>
        <p><b>Tel√©fono:</b> {{ op.proveedor.telefono|default:"-" }}</p>
        <p><b>CI:</b> {{ op.proveedor.ci|default:"-" }} &nbsp; <b>NIT:</b> {{ op.proveedor.nit|default:"-" }}</p>
        <p><b>Datos de transferencia:</b> {{ op.proveedor.datos_transferencia|default:"-" }}</p>
        <p><b>Entidad:</b> {{ op.proveedor.entidad|default:"-" }}</p>
        <p><b>Nro. Cuenta:</b> {{ op.proveedor.nro_cuenta|default:"-" }}</p>
      </div>
    </div>

  </form>

  <div class="card kv">
    <h3 class="m0">Registro</h3>

    <p>
      <b>Creado por:</b> {{ op.creado_por.get_full_name|default:op.creado_por.username }}
      {% if op.creado_en %} ({{ op.creado_en|date:"d/m/Y H:i" }}){% endif %}
    </p>

    <p>
      <b>Revisado por:</b>
      {% if op.revisado_por %}
        {{ op.revisado_por.get_full_name|default:op.revisado_por.username }}
        {% if op.revisado_en %} ({{ op.revisado_en|date:"d/m/Y H:i" }}){% endif %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>

    <p>
      <b>Aprobado por:</b>
      {% if op.aprobado_por %}
        {{ op.aprobado_por.get_full_name|default:op.aprobado_por.username }}
        {% if op.aprobado_en %} ({{ op.aprobado_en|date:"d/m/Y H:i" }}){% endif %}
      {% else %}
        ‚Äî
      {% endif %}
    </p>
    {% if op.rechazado_por and op.rechazado_en %}
      <p><b>Rechazado por:</b> {{ op.rechazado_por.get_full_name|default:op.rechazado_por.username }}</p>
      <p><b>Rechazado en:</b> {{ op.rechazado_en|date:"d/m/Y H:i" }}</p>
    {% endif %}

  </div>

    {# Botones abajo (despu√©s de Registro) #}
  <div class="card">
    <div class="hstack">
      {% if op.estado == "BORRADOR" %}
        {% if op.creado_por_id == user.id or user.is_superuser %}
          <a class="btn btn-primary" href="{% url 'op_send_review' op.pk %}">üì§ Enviar a revisi√≥n</a>
        {% endif %}

      {% elif op.estado == "EN_REVISION" %}
        {% if is_reviewer %}
          <a class="btn btn-primary" href="{% url 'op_mark_reviewed' op.pk %}">‚úÖ Marcar como revisado</a>
          <a class="btn btn-ghost" href="{% url 'op_back_to_draft' op.pk %}">‚Ü©Ô∏è Devolver a borrador</a>
        {% endif %}

      {% elif op.estado == "REVISADO" %}
        {% if is_approver and not is_reviewer %}
          <form method="post" action="{% url 'op_approve_final' op.pk %}" class="inline-form">
            {% csrf_token %}
            <button class="btn btn-primary" type="submit">‚úÖ Aprobar</button>
          </form>

          <form method="post" action="{% url 'op_back_to_review' op.pk %}" class="inline-form">
            {% csrf_token %}
            <button class="btn" type="submit">‚Ü©Ô∏è Devolver a revisi√≥n</button>
          </form>

          <form method="post" action="{% url 'op_reject' op.pk %}" class="inline-form">
            {% csrf_token %}
            <button class="btn btn-danger" type="submit"
              onclick="return confirm('¬øRechazar la OP {{ op.number }}?');"
            >‚ùå Rechazar</button>
          </form>
        {% endif %}

      {% elif op.estado == "APROBADO" %}
        <span class="muted">‚úÖ OP aprobada.</span>

      {% elif op.estado == "RECHAZADO" %}
        <span class="muted">‚ùå OP rechazada.</span>

      {% endif %}

      <a class="btn btn-ghost" href="{% url 'op_list' %}">‚Üê Volver</a>
    </div>
  </div>
</div>

{% endblock %}
